<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">

<head>
    <title></title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="./../../../lib/mint-ui/style.css">
    <link rel="stylesheet" href="./../../../appcan/css/ui-box.css">
    <link rel="stylesheet" href="./../../../appcan/css/ui-color.css">
    <link rel="stylesheet" href="./../../../lib/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="./../../../common/css/jas-main.css">
    <style type="text/css">
        .logo {
            margin: 0 auto;
        }

        .logo img {
            height: 70px;
            width: 70px;
        }
    </style>
</head>

<body class="um-vp" ontouchstart>
    <div id="page_0" class="up ub ub-ver bc-bg" tabindex="0">
        <jas-header title="版本更新"></jas-header>
        <div id="content" style="margin-top:0.625em;">
            <div class="logo" style="background:#fff;margin-left:0.625em;margin-right:0.625em">
                <div class="ub ub-pc uinn logo" style="padding:0;padding-top:20px;padding-bottom:20px">
                    <img src="../../../common/images/login.png" alt="企业logo">
                </div>
                <div class="ub ub-pc">
                    <span style="color:#333" v-model="versionTitle">---</span>
                </div>

                <div class="" style="border:none;padding:25px 10px;width:100%;">
                    <mt-button size="small" type="primary" style="width:100%" v-model="update" @click="update">立即更新</mt-button>
                </div>
            </div>
            <p style="color:#333;" v-model="versionSubTitle"></p>
        </div>
    </div>
    <script src="./../../../appcan/js/appcan.js"></script>
    <script src="./../../../lib/vue/vue.js"></script>
    <script src="./../../../lib/mint-ui/index.js"></script>
    <script src="./../../../common/js/common_device.js"></script>
    <script src="./../../../common/js/common_download.js"></script>
    <script src="./../../../common/js/jas-tools.js"></script>
    <script src="./../../../common/components/jas-components.js"></script>
</body>
<script>
    var vm = new Vue({
        el: "#page_0",
        data: function () {
            return {
                isUpdate: 0,
                downUrl: "",
                versionTitle: "",
                update: "",
                versionSubTitle: ""
            }
        },
        mounted: function () {
            var that = this;
            appcan.ready(function () {
                that.getAppVersionFromServer();
            });
        },
        methods: {
            getAppVersionFromServer: function () {
                var that = this;
                try {
                    var partURL1 =
                        "cloudlink-core-framework/appversion/getActiveVersion?productId=pipeline-bodyguard&clientType=Android";
                    jasHttpRequest.jasHttpGet(partURL1, function (id, state, dbSource) {
                        if (dbSource == "") {
                            return;
                        }
                        var obj = JSON.parse(dbSource);
                        if (obj.success == 1) {
                            if (obj.rows.length > 0) {
                                /*
                                 *服务端信息
                                 */
                                var appServer_Version = obj.rows[0].versionNumber;
                                var appServer_appVersion = obj.rows[0].appcanVersion;
                                var appServer_Desc = that.versionDesc(obj.rows[0].versionDesc);
                                that.downUrl = obj.rows[0].url;
                                /*
                                 * 客户端信息
                                 */
                                uexWidgetOne.getCurrentWidgetInfo();
                                uexWidgetOne.cbGetCurrentWidgetInfo = function (opId, dataType,
                                    data) {
                                    var appClient = eval('(' + data + ')');
                                    var appCliehtVersion = appClient.version;
                                    if (that.isExistNewVersion(appCliehtVersion,
                                            appServer_appVersion)) {
                                        that.isUpdate = 1;
                                        that.versionTitle = "发现新版本  " + appServer_appVersion;
                                        that.versionSubTitle = appServer_Desc;
                                        that.update = "立即更新";
                                    } else {
                                        that.isUpdate = 0;
                                        that.versionTitle = "已经是最新版 " + appCliehtVersion;
                                        that.versionSubTitle = "";
                                        that.update = "暂无更新";
                                    }
                                }
                            }
                        } else {

                            uexWidgetOne.getCurrentWidgetInfo();
                            uexWidgetOne.cbGetCurrentWidgetInfo = function (opId, dataType, data) {
                                var appClient = eval('(' + data + ')');
                                var appCliehtVersion = appClient.version;
                                that.versionTitle = "已经是最新版 " + appCliehtVersion;
                                that.versionSubTitle = "";
                                that.update = "暂无更新";
                            }
                        }
                    });
                } catch (e) {
                    uexWidgetOne.getCurrentWidgetInfo();
                    uexWidgetOne.cbGetCurrentWidgetInfo = function (opId, dataType, data) {
                        var appClient = eval('(' + data + ')');
                        var appCliehtVersion = appClient.version;
                        that.versionTitle = "已经是最新版 " + appCliehtVersion;
                        that.versionSubTitle = "";
                        that.update = "暂无更新";
                    }
                }
            },
            update: function () {
                var that = this;
                if (that.isUpdate == 1) {
                    that.isUpdate = 0;
                    that.downloadRightNow();
                }
            },
            downloadRightNow: function () { //立即更新
                var that = this;
                JasDevice.getConnectStatus(function (params) {
                    if (params == 0) {
                       downLoadNewApp(that.downUrl);
                    } else if (params == -1) {
                        that.$toast("您好，当前无网络，无法下载!");
                    } else {
                        appcan.window.alert({
                            title: "温馨提示",
                            content: "您正在使用流量进行下载，是否继续？",
                            buttons: ['是', '否'],
                            callback: function (err, data, dataType, optId) {
                                if (!err && data == "0") {
                                    downLoadNewApp(that.downUrl);
                                }
                            }
                        });
                    }
                });
            },
            versionDesc: function (_desc) {
                try {
                    if (_desc != "") {
                        var list = _desc.split('&');
                        var tempStr = "";
                        for (var i = 0; i < list.length; i++) {
                            tempStr += list[i] + "<br/>";
                        };
                        return tempStr;
                    } else {
                        return "暂无说明";
                    }
                } catch (e) {
                    return "暂无说明";
                }
            },
            isExistNewVersion: function (_clientVersion, _serverVersion) {
                try {
                    var _client = _clientVersion.replace(/\./g, "");
                    var _server = _serverVersion.replace(/\./g, "");

                    if (parseInt(_server) > parseInt(_client)) {
                        return true;
                    }
                    return false;
                } catch (e) {
                    return false;
                }
            }

        }
    })
</script>

</html>